# Copyright (c) 2025 Accenture, All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: openbsw-host-module-dameonset
  namespace: jenkins
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  selector:
    matchLabels:
      app: openbsw-host-module
  template:
    metadata:
      labels:
        app: openbsw-host-module
    spec:
      hostPID: true
      hostNetwork: true
      nodeSelector:
        workloadLabel: openbsw
      tolerations:
        - key: "workloadType"
          operator: "Equal"
          value: "openbsw"
          effect: "NoSchedule"
      serviceAccountName: jenkins-sa
      containers:
        - name: openbsw-host-module
          image: ubuntu:22.04
          securityContext:
            privileged: true
          volumeMounts:
            - name: host-lib-modules
              mountPath: /lib/modules
              readOnly: false
          command:
            - /bin/bash
            - -c
            - |
              set -euxo pipefail

              # List modules
              ls -la /lib/modules/$(uname -r) || true

              # Install module packages that ship extra drivers
              apt-get update -y
              apt-get install -y kmod  || true
              apt-get install -y can-utils  || true

              # DOES NOT EXIST
              # apt-get install -y --no-install-recommends linux-modules-extra-$(uname -r) || true

              # Rebuild module dependency map and attempt to load your required modules
              depmod -a

              # Install can modules
              modprobe can || true
              modprobe can-raw || true
              modprobe vcan || true

              # Show modules
              lsmod

              # Dump status
              dmesg | egrep -i 'module|modprobe|loading' || true

              # Stay alive to keep DaemonSet running
              sleep infinity
      volumes:
        - name: host-lib-modules
          hostPath:
            path: /lib/modules
